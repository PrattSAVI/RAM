<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.3/jquery.scrollTo.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- DATA PROCESSING -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.15.0/lodash.min.js"></script>

    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>


    <title>RAM_TEST</title>

    <style>
        body {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }
        
        #screen {
            height: 600px;
            padding: 5px 5px 5px 5px;
        }
        
        .element {
            background-color: brown;
            height: 100%;
        }
        
        .place-list {
            font-size: 11pt;
            padding: 5px 5px 5px 5px;
            background-color: cadetblue;
            margin: 5px 5px 5px 5px;
        }
        
        #holder {
            padding: 5px 5px 5px 5px;
            height: 100%;
            overflow-y: scroll;
            overflow-x: hidden;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row">
            <h1>RAM_WORKING</h1>
        </div>

        <div class="row">
            <div class="col-9" id="screen">
                <div class=element id="map"></div>
            </div>
            <div class="col-3" id="screen">
                <div class=element id="holder"></div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    // START MAP HERE
    var map = L.map('map').setView([40.832, -73.923], 10);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' + 'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/light-v9',
        tileSize: 512,
        zoomOffset: -1
    }).addTo(map);

    //Add Home Button
    L.easyButton('<i class="material-icons" style="font-size:18px;padding-bottom: 3px; display: inline-flex; vertical-align: middle;">home</i>', function(btn, map) {
        map.setView([40.832, -73.923], 10);
    }, 'Zoom To Home').addTo(map);

    // Polygon Style
    let style = {
        fillColor: "#f4a261",
        weight: 0,
        opacity: 1,
        fillOpacity: 0.7
    };

    // Prepare Pop Up Function Build Pop Up
    function onEachFeature(feature, layer) {
        var popupContent = `<b>Name:</b> ${feature.properties.SiteName} <br> 
                <b>ID:</b>${feature.properties.CRPID}<br>
                <b>Contact:</b>${feature.properties.Contact}`;
        layer.bindPopup(popupContent);
    };

    // Generate DOM elements based on data.
    // Class place-list is also used in click interaction
    function generatePanel(data) {
        data.features.forEach(f => {
            // HTML elements
            let name = f.properties.SiteName;
            let uid = f.properties.CRPID;
            let html_text = `<b>${name}</b><br>
            id: ${uid} <br>
            <b>Contact:</b>${f.properties.Contact}`

            // Create new DIV using JQuery
            $("<div/>").appendTo('#holder')
                .attr('id', uid)
                .attr('class', 'place-list')
                .html(html_text);
        })
    };

    // Generate each polygon by binding pop up as well. 
    // Pop-up Binding: onEachFeature, Style = style
    function generatePolygon(data, L) {
        //data.features.forEach(f => {
        let geoJsonLayer = L.geoJSON(data, {
            style: style,
            onEachFeature: onEachFeature
        }).addTo(map);

        geoJsonLayer.eachLayer(function(layer) {
            layer._path.id = layer.feature.properties.CRPID;
        });
    }

    let url = "data/Test_DB.geojson"

    //Use D3 to read JSON -> This might be an overkill. 
    //d3.json(url).then(function(data) {
    $.getJSON(url, function(data) {
        console.log(data);

        generatePanel(data);

        generatePolygon(data, L);

        // ------------------------------ CLICKS & INTERACTION
        // Watch clicks on #holder to fly to the bounds of the clicked element.
        $('.place-list').click(function(d) {
            let uid = $(this).attr("id")
                // extract clicked on geometry
            let filtered = data.features.filter(function(f) {
                return f.properties.CRPID == uid
            });
            map.flyToBounds(L.geoJson(filtered).getBounds());
        })

        //Scroll to clicked Element
        $('path').click(function(d) {
            let uid = $(this).attr("id")
            uid = `#holder #${uid}`;
            $("#holder").scrollTo($(uid), {
                axis: "y",
                duration: 1500
            })


        });

    });
</script>